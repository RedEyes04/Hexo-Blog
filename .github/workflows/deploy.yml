name: Deploy Hexo Blog

on:
  push:
    branches:
      - main  # 监听推送到 main 分支的操作
    paths:
      - 'source/_posts/**'  # 只在 source/_posts 下的文件变化时触发

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 检出仓库的最新版本
    - name: Checkout repository
      uses: actions/checkout@v3

    # 使用 rsync 将文件同步到服务器
    - name: Deploy with rsync
      run: |
        sudo apt-get install -y rsync
        rsync -avz -e "ssh -o StrictHostKeyChecking=no" source/_posts/ root@${{ secrets.SERVER_HOST }}:/blog/source/_posts/
      env:
        RSYNC_RSH: 'ssh -i "${{ secrets.SERVER_SSH_KEY }}"'
      
    # 在服务器上执行 Hexo 相关命令
    - name: Run hexo commands on server
      run: |
        ssh -o StrictHostKeyChecking=no -i "${{ secrets.SERVER_SSH_KEY }}" root@${{ secrets.SERVER_HOST }} "cd /blog && hexo g && hexo d"
